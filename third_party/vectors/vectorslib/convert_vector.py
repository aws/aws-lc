#!/usr/bin/env python3

import sys
import tomllib
import tempfile
import pathlib
import subprocess
import filecmp
import shutil
import argparse
import os
import json
import string
import textwrap

from vectorslib import utils


class TxtTemplate:
    """Adapted from crypto/test/file_test.h"""

    ATTRIBUTE = string.Template("$name = $value\n")
    INSTRUCTION = string.Template("[$name = $value]\n")
    INSTRUCTION_WITHOUT_VALUE = string.Template("[$name]\n")

    TC_ID = string.Template("# tcId = $tcId\n")
    COMMENT = string.Template("# $comment\n")

    # Same header as convert_wycheproof.go for backwards compatibility
    TEST_FILE = string.Template(
        r"""# Imported from Wycheproof's $infile.
# This file is generated by convert_wycheproof.go. Do not edit by hand.
#
# Algorithm: $algorithm
# Generator version: $genVer

"""
    )


def add_instruction(out, name, value):
    if isinstance(value, str) or isinstance(value, int):
        out.write(TxtTemplate.INSTRUCTION.substitute({"name": name, "value": value}))
    elif isinstance(value, dict):
        sorted_keys = sorted(value.keys())
        for key in sorted_keys:
            out.write(
                TxtTemplate.INSTRUCTION.substitute(
                    {"name": name + "." + key, "value": value[key]}
                )
            )
    else:
        raise Exception(f"unknown type: {type(value)}")


def add_attribute(out, name, value):
    if isinstance(value, str) or isinstance(value, int):
        out.write(TxtTemplate.ATTRIBUTE.substitute({"name": name, "value": value}))
    else:
        raise Exception(f"unknown type: {type(value)}")


def add_tcId(out, tcId):
    out.write(TxtTemplate.TC_ID.substitute({"tcId": tcId}))


def add_comment(out, comment):
    if len(comment) > 0:
        out.write(TxtTemplate.COMMENT.substitute({"comment": comment}))


def add_flags(out, flags):
    if len(flags) > 0:
        add_attribute(out, "flags", ",".join(flags))


def remove_if_exists(the_list, to_remove):
    for key in to_remove:
        if key in the_list:
            the_list.remove(key)


def add_testGroup(out, testGroup):
    sorted_keys = sorted(testGroup.keys())
    to_remove = ["tests", "type", "source"]
    # Tests do not use JSON formats
    to_remove += ["jwk", "keyJwk", "privateKeyJwk"]
    # Tests use the more reasonable DER over PEM
    to_remove += ["keyPem", "privateKeyPem"]
    remove_if_exists(sorted_keys, to_remove)
    for key in sorted_keys:
        add_instruction(out, key, testGroup[key])
    out.write("\n")


def add_test(out, test):
    add_tcId(out, test["tcId"])
    add_comment(out, test["comment"])

    sorted_keys = sorted(test.keys())
    sorted_keys.remove("comment")
    sorted_keys.remove("tcId")
    sorted_keys.remove("flags")
    for key in sorted_keys:
        add_attribute(out, key, test[key])
    add_flags(out, test["flags"])
    out.write("\n")


def convert_file(infile: pathlib.Path, outfile: pathlib.Path):
    """Convert a Wycheproof JSON file to file_test.h format."""
    assert infile.is_file()
    outfile.parent.mkdir(parents=True, exist_ok=True)

    with open(infile, "r") as json_in:
        data = json.load(json_in)

    # Handle both old and new Wycheproof schema
    # Old schema: generatorVersion at top level
    # New schema: source.version in each testGroup
    gen_ver = data.get("generatorVersion")
    if gen_ver is None and data.get("testGroups"):
        # Extract from first test group's source
        first_group = data["testGroups"][0]
        source = first_group.get("source", {})
        gen_ver = source.get("version", "unknown")

    with open(outfile, "w") as out:
        out.write(
            TxtTemplate.TEST_FILE.substitute(
                {
                    "infile": infile.name,
                    "algorithm": data["algorithm"],
                    "genVer": gen_ver,
                }
            )
        )
        for group in data["testGroups"]:
            add_testGroup(out, group)
            for test in group["tests"]:
                add_test(out, test)


def main() -> int:
    parser = argparse.ArgumentParser()
    parser.add_argument(
        "--input",
        required=True,
        help="Wycheproof-formatted JSON file to convert",
    )
    parser.add_argument(
        "--output",
        required=True,
        help="Location to store file_test.h formatted TXT file",
    )
    args = parser.parse_args()

    infile = pathlib.Path(args.input)
    outfile = pathlib.Path(args.output)

    convert_file(infile, outfile)
    return 0


if __name__ == "__main__":
    sys.exit(main())
