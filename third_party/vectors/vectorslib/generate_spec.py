#!/usr/bin/env python3

import pathlib
import re
from typing import Dict, List


def _sort_key(path: pathlib.Path) -> tuple:
    """
    Sort key that groups files by common prefix, preferring longer matches.
    
    Extracts (base_name, test_type, full_name) where base_name is the
    filename with numeric/hash suffixes and test type removed.
    """
    name = path.stem
    # Remove test suffix and extract type
    if name.endswith("_sig_gen_test"):
        base = name[: -len("_sig_gen_test")]
        test_type = 0  # sig_gen sorts first
    elif name.endswith("_test"):
        base = name[: -len("_test")]
        test_type = 1
    else:
        return (name, 2, name)
    
    # Remove trailing numbers/hashes: "rsa_pkcs1_2048" -> "rsa_pkcs1"
    base = re.sub(r"(_\d+|_sha\d+)+$", "", base)
    return (base, test_type, name)


def generate_spec(cwd: pathlib.Path, sources: dict) -> str:
    spec = """# Test Vector Specification

*This file is generated by sync.py. Do not edit by hand.*

"""

    for source_name, source_info in sorted(sources.items()):
        spec += f"## {source_name}\n\n"

        upstream_path = source_info["upstream_path"]
        vector_files = sorted(upstream_path.rglob("*.json"), key=_sort_key)

        for vector_file in vector_files:
            relative_path = vector_file.relative_to(upstream_path)
            converted_file = relative_path.with_suffix(".txt")

            spec += f"AWS-LC MUST test against `{converted_file}`.\n"
        
        # Add blank line after each source section
        spec += "\n"

    return spec


def write_spec(cwd: pathlib.Path, sources: dict):
    spec_file = cwd / "vectors_spec.md"
    content = generate_spec(cwd, sources)
    spec_file.write_text(content)
