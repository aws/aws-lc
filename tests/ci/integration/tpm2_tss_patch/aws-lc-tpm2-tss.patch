From addb67ba10371f03a7ab42a82016f117f2efde10 Mon Sep 17 00:00:00 2001
From: Justin W Smith <justsmth@amazon.com>
Date: Fri, 14 Nov 2025 13:26:27 +0000
Subject: [PATCH] Support AWS-LC

---
 configure.ac                            | 6 ------
 src/tss2-esys/esys_crypto_ossl.c        | 2 +-
 src/tss2-fapi/ifapi_curl.c              | 6 +++---
 src/tss2-fapi/ifapi_verify_cert_chain.c | 2 +-
 test/unit/fapi-eventlog.c               | 2 +-
 5 files changed, 6 insertions(+), 12 deletions(-)

diff --git a/configure.ac b/configure.ac
index 9df86bce..d5f3bbe2 100644
--- a/configure.ac
+++ b/configure.ac
@@ -189,12 +189,6 @@ AS_IF([test "x$enable_esys" = xyes],
                              [libcrypto >= ossl_min_version],,
                              [AC_MSG_ERROR([ossl_err])])
            AC_DEFINE([OSSL], [1], [OpenSSL cryptographic backend])
-           AC_CHECK_LIB(crypto,[EVP_sm3], [
-               AC_DEFINE([HAVE_EVP_SM3], [1], [Support EVP_sm3 in openssl])],
-                [])
-           AC_CHECK_LIB(crypto, [EVP_sm4_cfb128], [
-               AC_DEFINE([HAVE_EVP_SM4_CFB], [1], [Support EVP_sm4_cfb in openssl])],
-                [])
            TSS2_ESYS_CFLAGS_CRYPTO="$CRYPTO_CFLAGS"
            TSS2_ESYS_LDFLAGS_CRYPTO="$CRYPTO_LIBS"
        ], [test "x$with_crypto" = xmbed], [
diff --git a/src/tss2-esys/esys_crypto_ossl.c b/src/tss2-esys/esys_crypto_ossl.c
index 50d00c4b..84b16347 100644
--- a/src/tss2-esys/esys_crypto_ossl.c
+++ b/src/tss2-esys/esys_crypto_ossl.c
@@ -711,7 +711,7 @@ iesys_cryptossl_pk_encrypt(TPM2B_PUBLIC *pub_tpm_key,
         goto_error(r, TSS2_ESYS_RC_MEMORY, "Could not duplicate OAEP label", cleanup);
     }
 
-    if (1 != EVP_PKEY_CTX_set0_rsa_oaep_label(ctx, label_copy, (int)strlen(label_copy) + 1)) {
+    if (1 != EVP_PKEY_CTX_set0_rsa_oaep_label(ctx, (uint8_t*)label_copy, (int)strlen(label_copy) + 1)) {
         OPENSSL_free(label_copy);
         goto_error(r, TSS2_ESYS_RC_GENERAL_FAILURE, "Could not set RSA label.", cleanup);
     }
diff --git a/src/tss2-fapi/ifapi_curl.c b/src/tss2-fapi/ifapi_curl.c
index 2b92210d..65096b5f 100644
--- a/src/tss2-fapi/ifapi_curl.c
+++ b/src/tss2-fapi/ifapi_curl.c
@@ -89,11 +89,11 @@ ifapi_get_crl_from_cert(X509 *cert, X509_CRL **crl) {
     int curl_rc;
 
     *crl = NULL;
-    for (int i = 0; i < sk_DIST_POINT_num(dist_points); i++) {
+    for (size_t i = 0; i < sk_DIST_POINT_num(dist_points); i++) {
         DIST_POINT      *dp = sk_DIST_POINT_value(dist_points, i);
         DIST_POINT_NAME *distpoint = dp->distpoint;
         if (distpoint->type == 0) {
-            for (int j = 0; j < sk_GENERAL_NAME_num(distpoint->name.fullname); j++) {
+            for (size_t j = 0; j < sk_GENERAL_NAME_num(distpoint->name.fullname); j++) {
                 GENERAL_NAME   *gen_name = sk_GENERAL_NAME_value(distpoint->name.fullname, j);
                 ASN1_IA5STRING *asn1_str = gen_name->d.uniformResourceIdentifier;
                 SAFE_FREE(url);
@@ -173,7 +173,7 @@ ifapi_curl_verify_ek_cert(char *root_cert_pem, char *intermed_cert_pem, char *ek
     X509_STORE_CTX        *ctx = NULL;
     X509_CRL              *crl_intermed = NULL;
     X509_CRL              *crl_ek = NULL;
-    int                    i;
+    size_t                    i;
     size_t                 ui;
     AUTHORITY_INFO_ACCESS *info = NULL;
     ASN1_IA5STRING        *uri = NULL;
diff --git a/src/tss2-fapi/ifapi_verify_cert_chain.c b/src/tss2-fapi/ifapi_verify_cert_chain.c
index df295d99..3fb475dc 100644
--- a/src/tss2-fapi/ifapi_verify_cert_chain.c
+++ b/src/tss2-fapi/ifapi_verify_cert_chain.c
@@ -65,7 +65,7 @@ get_issuer_url(X509 *cert) {
     if (!info)
         return NULL;
 
-    for (int i = 0; i < sk_ACCESS_DESCRIPTION_num(info); i++) {
+    for (size_t i = 0; i < sk_ACCESS_DESCRIPTION_num(info); i++) {
         ACCESS_DESCRIPTION *ad = sk_ACCESS_DESCRIPTION_value(info, i);
         if (OBJ_obj2nid(ad->method) == NID_ad_ca_issuers && ad->location->type == GEN_URI) {
             ASN1_IA5STRING *uri = ad->location->d.uniformResourceIdentifier;
diff --git a/test/unit/fapi-eventlog.c b/test/unit/fapi-eventlog.c
index 7e49e112..d3077a96 100644
--- a/test/unit/fapi-eventlog.c
+++ b/test/unit/fapi-eventlog.c
@@ -163,7 +163,7 @@ check_eventlog_pcr0(const char *file, uint32_t *pcr_list, size_t pcr_list_size,
 static void
 check_bios_hcrtm(void **state) {
 
-#ifdef __FreeBSD__
+#ifndef HAVE_EVP_SM3
     /* Free BSD does not support SM3 hashalg */
     skip();
 #endif
-- 
2.43.0

